####Troubleshooting Iteration {.tabset}

Jointly, Thomas take first crask. SARAH will doe breakpoints.
Thomas Do examples and posting to Stack for iteration troubleshooting
Both sarah and Thomas useful resources

Troubleshooting and good resources
-Troubleshooting iteration
  -Simple and complex approaches 
  -in development use verbose iteration   #covered
      -print() to give an update #covered
  -breakpoints debugging tool in r studio 
  -traceback - certainly an option    #Covered needs an example maybe
  -should you just ignore warnings()?  #covered
  
-Minimum reproducible examples #covered
  
  
####Overview
Believe it or not, there are only two types of errors and both are human. 1) Your code is written incorrectly (let's go find that missing ')'...). 2) You are telling your code to do something with data that it can't do with that data (let's figure out where we need to set ```na.rm=T```). Other error types (also human) do exist, but they are far less frequent.  

Troubleshooting iteration is often challenging and frustrating. Somtimes errors are obvious sometimes errors only show up when you start digging into outputs. Sometimes it works fine on the test data and fails on the real data. Ultimately debugging is an exercise in hypothesis testing "If I do this, I should get this result. Where did I not get the expected result and why?" We present you with a few pointers and resources here that should help you debug iteration. Ultimately you will end up using the collection of approaches that works best for your coding style. 

####Clues you need to troubleshoot

**Warnings** - Warnings are you prompt to check if there is a problem. Code will seldom fail to provide output on a warning, the question is whether or not it is the output you are after. When you see warnings you should run ```warnings()``` and see if it makes sense as to why there are warnings. ggplot, for example, will issue a warnings for each incomplete records (e.g. a value for y, but not x) but it will still plot everything that is complete. It is always good to pay attention to the number of warnings and periodically check that they are expected. If they are unexpected you may wish to dig deeper.

**Errors** - In short, errors occur when the functions used in your code encounters data that they can't use. Sometimes an error tells you what the problem is, more often it doesn't. Many errors are general and not specific to a function so you will want to google the function and the  error to see what people have discussed. 

**Unexpected behavior** - If you expect that ```1+1=2``` but your code returns ```3```, that is a good indicator you need to troubleshoot. It is always good to feed your code some data for which you already know the answer or output. Both positive and negative examples shoule be used. A positive example is one where you know it should work normally and a negative example is one where you know it should break. I often do this during code development as I am building different modules or chunks. Fundamentally I have two checks: 1) Is it doing what I expect it to do? 2) What happens if I slip an NA/NaN/Inf or an empty dataframe in there?

####Tracking down the error
Tracking the error down is usually the first step in fixing it. Once you track it down you can see which functions are involved in it or which data are involved in it. There are some simple tools you can use. 

**Traceback** - this is a somewhat newer feature of RStudio. Upon encountering an error, initiating the traceback and take you back up to the error. I find that it only sort of gets you close and isn't super helpful in saying 'this is what is wrong'. I look at it to get to the general location of the error. Sometimes that is the problem spot, sometimes the error is actually upstream and the spot it identifies just can't handle the output from the error upstream.

**Make your code verbose** - Iteration usually works until it doesn't - it will loop up to the point or dateset that breaks it. Depending on how you have written your code, you likely don't know where it actually failed. That is a fact of life with R and iteration. Iteration tends to hide errors and warnings and makes it difficult to see where things went wrong. We can fix that. The lowly ```print()``` command is your friend. During development phase, I have print statements that return some indicator of code progress. It may be the name of the data it is on, might be a case it is on, I set it to return whatever I think I want to know.

```{r Day4TroubleVerbose, echo=TRUE, eval=F}

###example of error and verbose progress
###use for loop example that ends on an NA in the middle
```

In this case, the code was fine, but it was not equipped to handle the data being thrown at it and it stopped on the dataset/loop step that was the problem. This approach can be used to detect both code problems and data problems. If it errors out on the first step of iteration, then it is a code or a data problem. If it can process at least one step properly before erroring out, it is probably a dataset issue.

**Step away from the iteration** - I often use this when first developing a loop and then when troubleshooting a specific case/dataset. In this appraoch you set the input data to the known issue or case you want to test and don't attempt to iterate over all the data. With out invoking the iteration, you then run each step of your code line by line to determine where the error occurs. This is used for fixing a code error and for troubleshooting a dataset. What does that look like?

```{r Day4TroubleStepByStep, echo=TRUE, eval=F}
OutDat<-NULL                    #define an empty variable
#for(i in 1:9){                 #often helpful to comment out the for loop during debugging
        i=5                     #debugging variable
              OutDat[i]<-i+1    
#             } 
```
Process wise:
  1) develop the code that works on the test example
  2) wrap it in a for loop
  3) run the for loop on more data
  4) identify bugs
  5) unwrap the for loop and debug specific cases causing problems

Lastly, don't spin your wheels for too long by yourself. Coding is a team effort.

####Ask for help 
We have talked about getting help before, but here we want to cover the "Minimim Reproducible Example (MRE)" and asking for help on Stack Overflow. This is actually a crucial part of debugging. Often the process of developing the MRE will actually answer your question.

**Steps for developing an MRE**:
  1.  Identify a common built-in dataset that has a structure that is vaguely similar to your data or write some simple code that mimics what you are trying to deal with. A good one to use is often ```mtcars``` which is in ggplot2. It hase integer data, continuous data, and categorical data. If you are using a random number generator for you data (e.g. ```rnorm``` then using ```set.seed()``` is advisable.) Don't try to reproduce your entire dataset, reproduce only what your code is using. If you have 40 variables, and your code only operates on 8, provide a dataframe wtih 8 variables (or 9 in the unlikely event the problem is in the unused variable). 
  
  2.  Strip your code down to the essentials - sometimes the bigger context of your code is relevant, usually it isn't. 
    A.  Remove variable names that are special to your data. Rename them simple things like ```x``` and ```y```. 
    B.  Decide which steps are 'bells and whistles' and what steps are essential to the problem you are having or essential to what the code needs to do. Remove the bells and whistles. Check to see if the code behavior changes with each removed step. 
    
  3.  Be able to clearly provide an example of what the code should produce as output. Your code may or may not be doing that. A common set up you see is: "I am trying to _____. Here is the code I have so far. I want it to produce output that looks like ____. However, it is not currently doing that, instead it is providing this output _____. What did I do wrong?"
  
  4.  Type your question in plain english avoiding jargon. Use proper punctuation, grammar, etc. Keep it short, but provide details. 
  
  5.  Assign some useful R tags, usually ```r``` and the name of the function you think is the issue. 
  
  6.  Reply to people, thank them for their suggestions, provide clarificatin, select an answer. Avoid initiating a wholly new question in the comments/discussion.

Here is an example of a question I posted in preparation for this training. Remeber that ugly for loop? It really bothered me so I wanted to see if there was a better way to do that!

https://stackoverflow.com/questions/70747292/assigning-multiple-text-flags-to-an-observation/70748841#70748841

Is that solution better than what I had? Is it better than the other answer? Maybe. In the end I think the solution I selected will make it easier to add other flags that may come up. But, I do have to call the tidyverse library, if that is the environment you work in then that is not a concern. Maybe there is slightly less code here. It is visually more appealing. I do like the direct handling of NA values.  





  
####Resources
https://stackoverflow.com/help/minimal-reproducible-example
https://adv-r.hadley.nz/debugging.html
